#pragma once

#include <optional>

#include "Data.h"
#include "Globals.h"

namespace Attacks {
    void Init();

    U64 IndexToU64(int index, int bits, U64 bitboard);
    U64 MaskB(int square);
    U64 MaskR(int square);
    U64 GenerateBishopAttacks(int square, U64 blockers);
    U64 GenerateRookAttacks(int square, U64 blockers);
    U64 GetBishopAttacks(int square, U64 blockers);
    U64 GetRookAttacks(int square, U64 blockers);
    U64 GetQueenAttacks(int square, U64 blockers);

    void FindMagics();

    extern U64 PawnMoves[2][64];
    extern U64 PawnCaptures[2][64];
    extern U64 KnightAttacks[64];
    extern U64 BishopAttacks[64][512];
    extern U64 RookAttacks[64][4096];
    extern U64 QueenAttacks[64];
    extern U64 KingAttacks[64];

    extern U64 SliderRays[64][64];

    inline U64 GetPieceAttacks(int pieceType, int square, U64 blockers = 0ULL) {
        switch (pieceType) {
            case N: return KnightAttacks[square];
            case B: return GetBishopAttacks(square, blockers);
            case R: return GetRookAttacks(square, blockers);
            case Q: return GetQueenAttacks(square, blockers);
            case K: return KingAttacks[square];
        }

        return 0ULL;
    }

    extern U64 AttackMasksB[64];
    extern U64 AttackMasksR[64];

    constexpr U64 NotFileA = 0xFEFEFEFEFEFEFEFEULL;
    constexpr U64 NotFileAB = 0xFCFCFCFCFCFCFCFCULL;
    constexpr U64 NotFileGH = 0x3F3F3F3F3F3F3F3FULL;
    constexpr U64 NotFileH = 0x7F7F7F7F7F7F7F7FULL;

    constexpr int RelevantBitsB[64] = {
        6, 5, 5, 5, 5, 5, 5, 6,
        5, 5, 5, 5, 5, 5, 5, 5,
        5, 5, 7, 7, 7, 7, 5, 5,
        5, 5, 7, 9, 9, 7, 5, 5,
        5, 5, 7, 9, 9, 7, 5, 5,
        5, 5, 7, 7, 7, 7, 5, 5,
        5, 5, 5, 5, 5, 5, 5, 5,
        6, 5, 5, 5, 5, 5, 5, 6
    };

    constexpr int RelevantBitsR[64] = {
        12, 11, 11, 11, 11, 11, 11, 12,
        11, 10, 10, 10, 10, 10, 10, 11,
        11, 10, 10, 10, 10, 10, 10, 11,
        11, 10, 10, 10, 10, 10, 10, 11,
        11, 10, 10, 10, 10, 10, 10, 11,
        11, 10, 10, 10, 10, 10, 10, 11,
        11, 10, 10, 10, 10, 10, 10, 11,
        12, 11, 11, 11, 11, 11, 11, 12
    };

    constexpr U64 MagicsB[64] = {
        0x202420204040080ULL, 0x1108100440802008ULL, 0x4221010522004000ULL, 0x104041080410213ULL,
        0x11040c0500208ULL, 0x1010900420020e00ULL, 0x240201500a0442ULL, 0x420041084000ULL,
        0x41866002140101ULL, 0x3004010204011aULL, 0x48100100510420ULL, 0x200808410c4022ULL,
        0x41044940340ULL, 0x41080a060e222040ULL, 0x920840242026008ULL, 0x90100822000ULL,
        0x1821000408020816ULL, 0x4012008020051ULL, 0x92480a0408002208ULL, 0xc008000082004000ULL,
        0x940046020a0002ULL, 0x2120200202012030ULL, 0x4400800500c82000ULL, 0x401000021080210ULL,
        0x10502004149000ULL, 0x111100008026801ULL, 0x521050130184200ULL, 0x6004004004010002ULL,
        0x40840002020201ULL, 0x8801020100405000ULL, 0x10280144030c0280ULL, 0x201003280420800ULL,
        0xc514000040401ULL, 0x2018040200100281ULL, 0x20cc23000080048ULL, 0x8006080e0080200ULL,
        0x30108200052200ULL, 0x10248b01000a1018ULL, 0x1004008088820800ULL, 0xe081420022020104ULL,
        0x610044440a220ULL, 0x800808820500800ULL, 0x1021404020801000ULL, 0x12100c208804802ULL,
        0x880880304040240ULL, 0x8010203480200100ULL, 0x41009121c948410ULL, 0x480802084a000040ULL,
        0xa1011010448020ULL, 0xa001040201040940ULL, 0x4000004404040000ULL, 0x4001001610441000ULL,
        0x582821090000ULL, 0x100100250410800ULL, 0x40048104010002ULL, 0x500822108212002cULL,
        0x90220802080200ULL, 0x8040020221040200ULL, 0x18040002108080cULL, 0x80840414ULL,
        0x8000084040850101ULL, 0x6002420a8010840ULL, 0x40089084980040ULL, 0x8041000a2008200ULL
    };

    constexpr U64 MagicsR[64] = {
        0x2180008129400010ULL, 0x8040200010004000ULL, 0x780083000200184ULL, 0x4100082210000500ULL,
        0x200100402000920ULL, 0x2a00100801020084ULL, 0x880110002000080ULL, 0x11800b0004a44080ULL,
        0x21800040018030ULL, 0x220400050002002ULL, 0x40801000200084ULL, 0x2080801000800800ULL,
        0x10800800040081ULL, 0x14a001008020004ULL, 0x2a0808042002100ULL, 0x8042000418804912ULL,
        0x6201818001400020ULL, 0xc020058021400180ULL, 0x100220010420080ULL, 0x305242000a002210ULL,
        0x4008010008100500ULL, 0x2008004008002ULL, 0x820040008024130ULL, 0x20000985104ULL,
        0x220800080204000ULL, 0x500240022000ULL, 0x1000108200420020ULL, 0x402042200100840ULL,
        0xa048008080080400ULL, 0x44040080800200ULL, 0x980080400020110ULL, 0x800000420023018cULL,
        0x80804000800020ULL, 0x402001401000ULL, 0x400104101002002ULL, 0x5500100080800800ULL,
        0x108020040400400ULL, 0x30800200800401ULL, 0x910b484104000250ULL, 0x40404082000401ULL,
        0x9100800040008020ULL, 0x4400481090020ULL, 0x210200010008080ULL, 0x2830001100210008ULL,
        0x1014001008010100ULL, 0x4010044010080120ULL, 0x1284100201040008ULL, 0xa004091020024ULL,
        0x80002000400040ULL, 0x802000400080ULL, 0x1000100085200680ULL, 0x8061002010000900ULL,
        0x25001004080100ULL, 0x20080040080ULL, 0x1001019210083400ULL, 0x8044008044010200ULL,
        0x6080022080401501ULL, 0xa0c8210200401082ULL, 0xa1000810200441ULL, 0x20080500201001ULL,
        0x21000800701205ULL, 0x1002000108041002ULL, 0x1090209002080104ULL, 0x4a88002084010042ULL
    };

    // constexpr U64 MagicsB[64] = {
    //     0x110040100440100ULL, 0x120480200802000ULL, 0x4040082100002ULL, 0x88208030088000ULL,
    //     0x221104000000400ULL, 0xe06013420080001ULL, 0x2400441014502f00ULL, 0x4002210808040200ULL,
    //     0x12a8081001083100ULL, 0x800200809404282ULL, 0x390100090910031ULL, 0x3040410846001ULL,
    //     0x800a1210000011ULL, 0x1800082a0200241ULL, 0x1000222100404a0ULL, 0x5024900a2212018ULL,
    //     0x40001909180492ULL, 0xa009282002008201ULL, 0x5010800808004208ULL, 0x2010206104008040ULL,
    //     0x10806c00a00c40ULL, 0xa02001820900810ULL, 0xa24900901000ULL, 0xd0c880822013001ULL,
    //     0x4034410205084808ULL, 0x2110408010800ULL, 0x9000180020a1ULL, 0x802008020220ULL,
    //     0x1010010104000ULL, 0x40c80200404100a4ULL, 0x2108010002011140ULL, 0x3024960081210400ULL,
    //     0x4008621020086040ULL, 0x3220c82c21202420ULL, 0x10c8000c0802ULL, 0x8069010800090040ULL,
    //     0x2400420020020080ULL, 0x2001020a00048808ULL, 0x8404008080020804ULL, 0x49042081a10058ULL,
    //     0x2000a8080880c000ULL, 0x2000441008004518ULL, 0x402002424012800ULL, 0x10104010400208ULL,
    //     0x188200410442400ULL, 0x10c000a808410080ULL, 0x28021c40408c00ULL, 0x30210048800100ULL,
    //     0x415048200042ULL, 0x800708821002b000ULL, 0x1c454101c04ULL, 0x120a020205ULL,
    //     0x1910880590440400ULL, 0x44030120082c0ULL, 0x2040802a8020000ULL, 0xc208c0506042000ULL,
    //     0x220802410020860ULL, 0x208044411088a000ULL, 0x8400031042009090ULL, 0x400020060420210ULL,
    //     0x8010040020204104ULL, 0x80000410820200ULL, 0x100100408009410ULL, 0x1010021024008410ULL,
    // };

    // constexpr U64 MagicsR[64] = {
    //     0x4080002410400480ULL, 0x4040100040002000ULL, 0x280200110008008ULL, 0x9600081200204004ULL,
    //     0x2200042002000810ULL, 0x820001c804100200ULL, 0x400008102100804ULL, 0x100104021000082ULL,
    //     0x800080400022ULL, 0x2001004000210080ULL, 0x1088801000200080ULL, 0x808808010000800ULL,
    //     0x2040808004000800ULL, 0x2286004802001004ULL, 0x5142000804010200ULL, 0x10a000418420485ULL,
    //     0x40168000802440ULL, 0x90054000600841ULL, 0x420010220081ULL, 0x4029920020400a00ULL,
    //     0x50008005100ULL, 0x80808004000200ULL, 0xa00040010018208ULL, 0x110020004204081ULL,
    //     0x400280008020ULL, 0x100400100288900ULL, 0x20490100200010ULL, 0x100080080100084ULL,
    //     0x8000080080040082ULL, 0x104000202000810ULL, 0x8809102c00180201ULL, 0x600004200040081ULL,
    //     0x6080002000400044ULL, 0x4000804000802012ULL, 0x2100200080801000ULL, 0x110001101000820ULL,
    //     0x8186820800800400ULL, 0x4040080800200ULL, 0x820100104000802ULL, 0x8148440a000085ULL,
    //     0x808000a001434003ULL, 0x20200050004000ULL, 0x8002004020820012ULL, 0xa24100025010009ULL,
    //     0x1008040801010010ULL, 0x2008408820010ULL, 0x301000200010004ULL, 0x4a040060820001ULL,
    //     0xc002088040210200ULL, 0x40004031048300ULL, 0x204110920004100ULL, 0x802100080480280ULL,
    //     0x8080080040080ULL, 0x85000244000900ULL, 0x530083d021400ULL, 0xc22840b431200ULL,
    //     0x3004220108202ULL, 0x110408a01002012ULL, 0x401081201208242ULL, 0x5000201001000509ULL,
    //     0x801000270080025ULL, 0x1001000208040001ULL, 0x1800080201009004ULL, 0x482400410592ULL,
    // };

    // constexpr U64 MagicsB[64] = {
    // 	0x40040822862081ULL, 0x40810a4108000ULL, 0x2008008400920040ULL, 0x61050104000008ULL,
    // 	0x8282021010016100ULL, 0x41008210400a0001ULL, 0x3004202104050c0ULL, 0x22010108410402ULL,
    // 	0x60400862888605ULL, 0x6311401040228ULL, 0x80801082000ULL, 0x802a082080240100ULL,
    // 	0x1860061210016800ULL, 0x401016010a810ULL, 0x1000060545201005ULL, 0x21000c2098280819ULL,
    // 	0x2020004242020200ULL, 0x4102100490040101ULL, 0x114012208001500ULL, 0x108000682004460ULL,
    // 	0x7809000490401000ULL, 0x420b001601052912ULL, 0x408c8206100300ULL, 0x2231001041180110ULL,
    // 	0x8010102008a02100ULL, 0x204201004080084ULL, 0x410500058008811ULL, 0x480a040008010820ULL,
    // 	0x2194082044002002ULL, 0x2008a20001004200ULL, 0x40908041041004ULL, 0x881002200540404ULL,
    // 	0x4001082002082101ULL, 0x8110408880880ULL, 0x8000404040080200ULL, 0x200020082180080ULL,
    // 	0x1184440400114100ULL, 0xc220008020110412ULL, 0x4088084040090100ULL, 0x8822104100121080ULL,
    // 	0x100111884008200aULL, 0x2844040288820200ULL, 0x90901088003010ULL, 0x1000a218000400ULL,
    // 	0x1102010420204ULL, 0x8414a3483000200ULL, 0x6410849901420400ULL, 0x201080200901040ULL,
    // 	0x204880808050002ULL, 0x1001008201210000ULL, 0x16a6300a890040aULL, 0x8049000441108600ULL,
    // 	0x2212002060410044ULL, 0x100086308020020ULL, 0x484241408020421ULL, 0x105084028429c085ULL,
    // 	0x4282480801080cULL, 0x81c098488088240ULL, 0x1400000090480820ULL, 0x4444000030208810ULL,
    // 	0x1020142010820200ULL, 0x2234802004018200ULL, 0xc2040450820a00ULL, 0x2101021090020ULL
    // };

    // constexpr U64 MagicsR[64] = {
    // 	0xa080041440042080ULL, 0xa840200410004001ULL, 0xc800c1000200081ULL, 0x100081001000420ULL,
    // 	0x200020010080420ULL, 0x3001c0002010008ULL, 0x8480008002000100ULL, 0x2080088004402900ULL,
    // 	0x800098204000ULL, 0x2024401000200040ULL, 0x100802000801000ULL, 0x120800800801000ULL,
    // 	0x208808088000400ULL, 0x2802200800400ULL, 0x2200800100020080ULL, 0x801000060821100ULL,
    // 	0x80044006422000ULL, 0x100808020004000ULL, 0x12108a0010204200ULL, 0x140848010000802ULL,
    // 	0x481828014002800ULL, 0x8094004002004100ULL, 0x4010040010010802ULL, 0x20008806104ULL,
    // 	0x100400080208000ULL, 0x2040002120081000ULL, 0x21200680100081ULL, 0x20100080080080ULL,
    // 	0x2000a00200410ULL, 0x20080800400ULL, 0x80088400100102ULL, 0x80004600042881ULL,
    // 	0x4040008040800020ULL, 0x440003000200801ULL, 0x4200011004500ULL, 0x188020010100100ULL,
    // 	0x14800401802800ULL, 0x2080040080800200ULL, 0x124080204001001ULL, 0x200046502000484ULL,
    // 	0x480400080088020ULL, 0x1000422010034000ULL, 0x30200100110040ULL, 0x100021010009ULL,
    // 	0x2002080100110004ULL, 0x202008004008002ULL, 0x20020004010100ULL, 0x2048440040820001ULL,
    // 	0x101002200408200ULL, 0x40802000401080ULL, 0x4008142004410100ULL, 0x2060820c0120200ULL,
    // 	0x1001004080100ULL, 0x20c020080040080ULL, 0x2935610830022400ULL, 0x44440041009200ULL,
    // 	0x280001040802101ULL, 0x2100190040002085ULL, 0x80c0084100102001ULL, 0x4024081001000421ULL,
    // 	0x20030a0244872ULL, 0x12001008414402ULL, 0x2006104900a0804ULL, 0x1004081002402ULL
    // };
}